name: Golden Test PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "lib/**/*.dart"
      - "test/**/*_golden_test.dart"
      - "test/**/goldens/**/*.png"

jobs:
  golden-test-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: "3.32.0"
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run golden tests and check for changes
        id: golden_test
        run: |
          # Clean up any existing failure images
          find test -name "*_masterImage.png" -delete 2>/dev/null || true
          find test -name "*_testImage.png" -delete 2>/dev/null || true

          # Run golden tests
          if flutter test --tags golden --reporter=json > test_results.json 2>&1; then
            echo "golden_test_passed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ All golden tests passed"
          else
            echo "golden_test_passed=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Golden tests failed - comparing images"
          fi

      - name: Check for new golden images (first-time generation)
        id: check_new_goldens
        run: |
          NEW_GOLDENS_FOUND=false
          NEW_GOLDENS_LIST=""

          # Check if there are any golden images that weren't in the base branch
          git fetch origin ${{ github.event.pull_request.base.ref }}

          # Find golden images in current branch
          if find test -name "*.png" -path "*/goldens/ci/*" | while read -r golden_file; do
            # Convert to relative path
            rel_path=${golden_file#./}

            # Check if this file exists in base branch
            if ! git cat-file -e origin/${{ github.event.pull_request.base.ref }}:$rel_path 2>/dev/null; then
              echo "true" > /tmp/new_golden_found
              echo "$rel_path" >> /tmp/new_goldens_list
              echo "üÜï New golden image found: $rel_path"
            fi
          done; then
            if [[ -f "/tmp/new_golden_found" ]]; then
              NEW_GOLDENS_FOUND=true
              NEW_GOLDENS_LIST=$(cat /tmp/new_goldens_list 2>/dev/null || echo "")
            fi
          fi

          echo "new_goldens_found=$NEW_GOLDENS_FOUND" >> $GITHUB_OUTPUT
          echo "new_goldens_list<<EOF" >> $GITHUB_OUTPUT
          echo "$NEW_GOLDENS_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check for failure images (Before/After comparison)
        id: check_failures
        run: |
          FAILURE_IMAGES_FOUND=false
          FAILURE_PAIRS=""

          # Look for failure images in test directories
          if find test -name "*_masterImage.png" | while read -r master_file; do
            # Extract the base name and find corresponding test image
            base_name=${master_file%_masterImage.png}
            test_file="${base_name}_testImage.png"

            if [[ -f "$test_file" ]]; then
              echo "true" > /tmp/failure_found
              # Extract just the filename without path for cleaner display
              master_filename=$(basename "$master_file")
              test_filename=$(basename "$test_file")
              widget_name=${master_filename%_masterImage.png}

              echo "$widget_name|$master_file|$test_file" >> /tmp/failure_pairs
              echo "üì∏ Failure pair found: $widget_name"
            fi
          done; then
            if [[ -f "/tmp/failure_found" ]]; then
              FAILURE_IMAGES_FOUND=true
              FAILURE_PAIRS=$(cat /tmp/failure_pairs 2>/dev/null || echo "")
            fi
          fi

          echo "failure_images_found=$FAILURE_IMAGES_FOUND" >> $GITHUB_OUTPUT
          echo "failure_pairs<<EOF" >> $GITHUB_OUTPUT
          echo "$FAILURE_PAIRS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate PR comment
        id: generate_comment
        run: |
          COMMENT_BODY="## üé® Golden Test Results\n\n"

          # Test execution status
          if [[ "${{ steps.golden_test.outputs.golden_test_passed }}" == "true" ]]; then
            COMMENT_BODY="${COMMENT_BODY}‚úÖ **Golden Tests**: All tests passed\n\n"
          else
            COMMENT_BODY="${COMMENT_BODY}‚ö†Ô∏è **Golden Tests**: Some tests failed - image comparison below\n\n"
          fi

          HAS_CHANGES=false

          # Handle new golden images (first-time)
          if [[ "${{ steps.check_new_goldens.outputs.new_goldens_found }}" == "true" ]]; then
            HAS_CHANGES=true
            COMMENT_BODY="${COMMENT_BODY}### ‚ú® New Golden Images\n\n"

            while IFS= read -r golden_path; do
              if [[ -n "$golden_path" ]]; then
                filename=$(basename "$golden_path")
                widget_name=${filename%.png}
                COMMENT_BODY="${COMMENT_BODY}#### üÜï \`$widget_name\`\n\n"
                COMMENT_BODY="${COMMENT_BODY}![New Golden Image](https://github.com/${{ github.repository }}/raw/${{ github.event.pull_request.head.sha }}/$golden_path)\n\n"
              fi
            done <<< "${{ steps.check_new_goldens.outputs.new_goldens_list }}"
          fi

          # Handle failure images (Before/After comparison)
          if [[ "${{ steps.check_failures.outputs.failure_images_found }}" == "true" ]]; then
            HAS_CHANGES=true
            COMMENT_BODY="${COMMENT_BODY}### üì∏ Golden Image Changes (Before/After)\n\n"

            COMMENT_BODY="${COMMENT_BODY}The following widgets have visual changes detected:\n\n"

            while IFS='|' read -r widget_name master_file test_file; do
              if [[ -n "$widget_name" ]]; then
                COMMENT_BODY="${COMMENT_BODY}#### üîÑ \`$widget_name\`\n\n"
                COMMENT_BODY="${COMMENT_BODY}- **Before Image**: \`$(basename "$master_file")\`\n"
                COMMENT_BODY="${COMMENT_BODY}- **After Image**: \`$(basename "$test_file")\`\n\n"
                COMMENT_BODY="${COMMENT_BODY}üìé **Download images**: Check the \`golden-test-failures\` artifact below to view the comparison images.\n\n"
              fi
            done <<< "${{ steps.check_failures.outputs.failure_pairs }}"

            COMMENT_BODY="${COMMENT_BODY}---\n\n"
            COMMENT_BODY="${COMMENT_BODY}üí° **How to view the images**:\n"
            COMMENT_BODY="${COMMENT_BODY}1. Scroll down to the \"Artifacts\" section in this workflow run\n"
            COMMENT_BODY="${COMMENT_BODY}2. Download the \`golden-test-failures\` artifact\n"
            COMMENT_BODY="${COMMENT_BODY}3. Extract the zip file to view Before (\`*_masterImage.png\`) and After (\`*_testImage.png\`) images\n\n"
          fi

          # If no changes detected
          if [[ "$HAS_CHANGES" == "false" ]]; then
            COMMENT_BODY="${COMMENT_BODY}‚úÖ No golden image changes detected.\n"
          fi

          # Add workflow run link for easy access to artifacts
          if [[ "$HAS_CHANGES" == "true" ]]; then
            COMMENT_BODY="${COMMENT_BODY}üîó **Workflow Run**: [View artifacts and details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n"
          fi

          # Save comment body
          echo "$COMMENT_BODY" > /tmp/comment_body.md
          echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT

      - name: Upload failure images as artifacts
        if: steps.check_failures.outputs.failure_images_found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: golden-test-failures
          path: |
            test/**/*_masterImage.png
            test/**/*_testImage.png
          retention-days: 7

      - name: Upload new golden images as artifacts
        if: steps.check_new_goldens.outputs.new_goldens_found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: new-golden-images
          path: |
            test/**/goldens/ci/*.png
          retention-days: 7

      - name: Find existing comment
        id: find_comment
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: "üé® Golden Test Results"

      - name: Create or update comment
        if: steps.generate_comment.outputs.has_changes == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body-path: /tmp/comment_body.md
          edit-mode: replace
